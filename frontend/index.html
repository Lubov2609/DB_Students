<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5}
h1{text-align:center}
.tabs{display:flex;gap:10px;justify-content:center;margin-bottom:20px}
.tab{padding:10px 20px;background:#e0e0e0;border-radius:8px;cursor:pointer}
.tab.active{background:#4caf50;color:#fff}
table{width:100%;border-collapse:collapse;background:#fff;margin-bottom:20px}
th,td{border:1px solid #ccc;padding:8px;text-align:left}
th{background:#e0e0e0}
.hidden{display:none}
button.action-btn{margin-right:5px}
#modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
#modal .modal-content{background:#fff;padding:20px;border-radius:8px;width:420px;max-width:90%}
#modal label{display:block;margin-top:10px}
#modal input,#modal select{width:100%;padding:6px;margin-top:5px;box-sizing:border-box}
#modal .buttons{text-align:right;margin-top:12px}
.error{color:red}
</style>
</head>
<body>
<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</h1>

<div class="tabs">
  <div class="tab active" data-target="students">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
  <div class="tab" data-target="lecturers">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</div>
  <div class="tab" data-target="courses">–ö—É—Ä—Å—ã</div>
  <div class="tab" data-target="grades">–û—Ü–µ–Ω–∫–∏</div>
  <div class="tab" data-target="student-panel">–°—Ç—É–¥–µ–Ω—Ç</div>


</div>

<div id="student-search" style="margin: 10px 0; display:none;">
    <input type="text" id="studentSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏–∏..." />
 </div>

<table id="students" class="table-block">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–û—Ç—á–µ—Å—Ç–≤–æ</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
</table>
<div id="lecturer-search" class="hidden" style="margin: 12px 0; display:flex; flex-direction: column; gap:10px;">
    
    <!-- –ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä -->
    <!-- <div id="letter-filter" style="display:flex; flex-wrap:wrap; gap:5px;"></div> -->

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
<!-- <div id="lecturer-search" style="display:flex; gap:10px;">
        <button onclick="sortLecturersByDate('asc')">üìÖ –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</button>
        <button onclick="sortLecturersByDate('desc')">üìÖ –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</button>
 </div> -->
    <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ñ–µ–¥—Ä–µ -->
    <!-- <input type="text" id="departmentSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ñ–µ–¥—Ä–µ..." />
</div> -->
  <table id="lecturers" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ö–∞—Ñ–µ–¥—Ä–∞</th><th>–ü—Ä–∏–Ω—è—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="courses" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ó–∞—á—ë—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã</th><th>–î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</th><th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="grades" class="table-block hidden">
    <thead><tr><th>ID</th><th>–°—Ç—É–¥–µ–Ω—Ç (—Ñ–∞–º–∏–ª–∏—è)</th><th>–ö—É—Ä—Å</th><th>–°–µ–º–µ—Å—Ç—Ä</th><th>–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</th><th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- ---------------- –í–ö–õ–ê–î–ö–ê "–°–¢–£–î–ï–ù–¢" ---------------- -->
<!-- 
 <select id="student-select">
<button id="showStudentStatsBtn">–ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</button>
<div id="student-stats"></div>
<button id="downloadStatsBtn">–°–∫–∞—á–∞—Ç—å CSV</button>
<canvas id="studentChart"></canvas>
<div id="student-panel" class="table-block hidden" style="padding:20px;">  -->
<!-- ---------------- –í–ö–õ–ê–î–ö–ê "–°–¢–£–î–ï–ù–¢" ---------------- -->

<!-- =================== –í–ö–õ–ê–î–ö–ê –°–¢–£–î–ï–ù–¢ =================== -->

<div id="student-panel" class="hidden" style="padding:20px;">
    <h2>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>

    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:</label><br>
    <select id="stat-student-select" style="padding:5px; width:300px; margin:10px 0;">
        <option value="">-- –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω --</option>
    </select>

    <div id="course-block" class="hidden">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω–µ—Ç –æ—Ü–µ–Ω–∫–∏:</label><br>
        <select id="stat-course-select" style="padding:5px; width:300px; margin:10px 0;">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç --</option>
        </select>

        <button id="makePredictionBtn"
                style="padding:6px 12px; background:#673ab7; color:white;">
            –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
        </button>
    </div>

    <div id="prediction-result" style="margin-top:20px; font-size:18px;"></div>

    <canvas id="studentChart" width="800" height="400" style="margin-top:30px;"></canvas>
</div>



<!-- Modal -->
<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</h3>
    <form id="modal-form">
      <div id="form-fields"></div>
      <div class="error" id="form-error"></div>
      <div class="buttons">
        <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ---------- state ---------- */
const tabs = document.querySelectorAll('.tab');
const tables = document.querySelectorAll('.table-block');
let activeTable = 'students';
let editId = null;

/* helper to get primary key field name for each table */
function getIdKey(table){
  switch(table){
    case 'students': return 'student_id';
    case 'lecturers': return 'lecturer_id';
    case 'courses': return 'course_id';
    case 'grades': return 'grade_id';
    case "student-panel":      // ‚Üê –î–û–ë–ê–í–ò–¢–¨
        loadStudentList();     // ‚Üê –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        break;
    default: return 'id';
  }
}

/* ---------- tabs handling ---------- */
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTable = tab.dataset.target;
    tables.forEach(tbl=>tbl.classList.add('hidden'));
    document.getElementById(activeTable).classList.remove('hidden');
    loadData(activeTable);
      // ---- –ü–û–ö–ê–ó –ü–û–ò–°–ö–ê –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í ----
    const searchBlock = document.getElementById("student-search");
    if (activeTable === "students") {
        searchBlock.style.display = "block";
    } else {
        searchBlock.style.display = "none";
    }
    // –§–∏–ª—å—Ç—Ä—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
const lectFilter = document.getElementById("lecturer-search");
if (activeTable === "lecturers") {
    lectFilter.classList.remove("hidden");
} else {
    lectFilter.classList.add("hidden");
}
  });
});

/* ---------- load data ---------- */
async function loadData(table){
  try{
    const res = await fetch(`/api/${table}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderTable(table, data);
  }catch(err){
    console.error(err);
    const tbody = document.querySelector(`#${table} tbody`);
    tbody.innerHTML = `<tr><td colspan="20" class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>`;
  }
}

/* ---------- renderers for each table (explicit columns) ---------- */
function renderTable(table, rows){
  const tbody = document.querySelector(`#${table} tbody`);
  tbody.innerHTML = '';

  if(!Array.isArray(rows) || rows.length===0){
    tbody.innerHTML = `<tr><td colspan="20">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    // for students/lecturers/courses allow add button row even if empty
    if(table !== 'grades') appendAddRow(table, tbody);
    return;
  }

  if(table==='students'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.student_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.pytronimic || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.birth_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('students', ${r.student_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('students', ${r.student_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='lecturers'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.lecturer_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.hire_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('lecturers', ${r.lecturer_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('lecturers', ${r.lecturer_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='courses'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.course_id}</td>
        <td>${r.title || ''}</td>
        <td>${r.description || ''}</td>
        <td>${r.credits || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.lecturer_last_name || (r.lecturer_id || '')}</td>
        <td>
          <button class="action-btn" onclick="openModal('courses', ${r.course_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('courses', ${r.course_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='grades'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.grade_id}</td>
        <td>${r.student_last_name ||   ''} ${r.student_first_name || ''} ${r.student_pytronimic || ''}</td>
        <td>${r.course_title || ''}</td>
        <td>${r.semester || ''}</td>
        <td>${r.final_grade || ''}</td>
        <td>${r.created_at || ''}</td>`;
      tbody.appendChild(tr);
    });
    // no add/edit/delete row appended here? We might allow add ‚Äî keep add option:
    appendAddRow(table, tbody, true); // allow add for grades but no edit/delete in rows
    return;
  }
}

/* add-row: creates a full-width row with "Add" button; if forGradesAddOnlyOnly flag */
function appendAddRow(table, tbody, gradesAddOnly=false){
  const tr = document.createElement('tr');
  const colCount = tbody.parentElement.querySelector('thead tr').children.length;
  const td = document.createElement('td');
  td.colSpan = colCount;
  if(table==='grades') {
    td.innerHTML = `<button onclick="openModal('grades')">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>`;
  } else {
    td.innerHTML = `<button onclick="openModal('${table}')">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
  }
  tr.appendChild(td);
  tbody.appendChild(tr);
}

/* ---------- CRUD actions ---------- */
async function deleteRow(table, id){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ID=${id} –∏–∑ ${table}?`)) return;
  try{
    const res = await fetch(`/api/${table}/${id}`, { method:'DELETE' });
    if(!res.ok) throw new Error('Delete error');
    await loadData(table);
  }catch(err){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); console.error(err); }
}

/* ---------- Modal logic ---------- */
const modal = document.getElementById('modal');
const modalForm = document.getElementById('modal-form');
const formFields = document.getElementById('form-fields');
const modalTitle = document.getElementById('modal-title');
const formError = document.getElementById('form-error');

function openModal(table, id=null){
  editId = id;
  modalTitle.textContent = id ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${table}` : `–î–æ–±–∞–≤–∏—Ç—å –≤ ${table}`;
  formError.textContent = '';
  formFields.innerHTML = '';

  // build fields depending on table; if editId set, fetch item to prefill
  if(editId){
    // fetch existing record to prefill
    fetch(`/api/${table}/${editId}`).then(r=>r.json()).then(item=>{
      buildFields(table, item);
      modal.style.display = 'flex';
    }).catch(err=>{
      console.error(err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    });
  } else {
    buildFields(table, null).then(()=> modal.style.display = 'flex');
  }
}

function closeModal(){ modal.style.display = 'none'; editId = null; modalForm.reset(); }

window.onclick = (e)=>{ if(e.target===modal) closeModal(); }

async function buildFields(table, item){
  // returns a Promise because we may fetch lists for selects
  formFields.innerHTML = '';
  if(table==='students'){
    formFields.innerHTML += `<label>–ò–º—è:<input name="first_name" value="${item?.first_name || ''}" required></label>`;
    formFields.innerHTML += `<label>–û—Ç—á–µ—Å—Ç–≤–æ:<input name="middle_name" value="${item?.middle_name || ''}"></label>`;
    formFields.innerHTML += `<label>–§–∞–º–∏–ª–∏—è:<input name="last_name" value="${item?.last_name || ''}" required></label>`;
    formFields.innerHTML += `<label>Email:<input name="email" type="email" value="${item?.email || ''}"></label>`;
    formFields.innerHTML += `<label>–¢–µ–ª–µ—Ñ–æ–Ω:<input name="phone_number" value="${item?.phone_number || ''}"></label>`;
    formFields.innerHTML += `<label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:<input name="birth_date" placeholder="YYYY-MM-DD" value="${item?.birth_date || ''}"></label>`;
    return Promise.resolve();
  }

  if(table==='lecturers'){
    formFields.innerHTML += `<label>–ò–º—è:<input name="first_name" value="${item?.first_name || ''}" required></label>`;
    formFields.innerHTML += `<label>–§–∞–º–∏–ª–∏—è:<input name="last_name" value="${item?.last_name || ''}" required></label>`;
    formFields.innerHTML += `<label>Email:<input name="email" type="email" value="${item?.email || ''}"></label>`;
    formFields.innerHTML += `<label>–¢–µ–ª–µ—Ñ–æ–Ω:<input name="phone_number" value="${item?.phone_number || ''}"></label>`;
    formFields.innerHTML += `<label>–ö–∞—Ñ–µ–¥—Ä–∞:<input name="department" value="${item?.department || ''}"></label>`;
    formFields.innerHTML += `<label>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:<input name="hire_date" placeholder="YYYY-MM-DD" value="${item?.hire_date || ''}"></label>`;
    return Promise.resolve();
  }

  if(table==='courses'){
    // need lecturers list for select
    const lecturers = await fetch('/api/lecturers').then(r=>r.json());
    let options = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>`;
    lecturers.forEach(l => {
      const selected = item && (l.lecturer_id === item.lecturer_id) ? 'selected' : '';
      options += `<option value="${l.lecturer_id}" ${selected}>${l.last_name} (${l.first_name})</option>`;
    });
    formFields.innerHTML += `<label>–ù–∞–∑–≤–∞–Ω–∏–µ:<input name="title" value="${item?.title || ''}" required></label>`;
    formFields.innerHTML += `<label>–û–ø–∏—Å–∞–Ω–∏–µ:<input name="description" value="${item?.description || ''}"></label>`;
    formFields.innerHTML += `<label>–ö—Ä–µ–¥–∏—Ç—ã:<input name="credits" type="number" value="${item?.credits || ''}"></label>`;
    formFields.innerHTML += `<label>–ö–∞—Ñ–µ–¥—Ä–∞:<input name="department" value="${item?.department || ''}"></label>`;
    formFields.innerHTML += `<label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:<select name="lecturer_id">${options}</select></label>`;
    return;
  }

  // ---------------- –§–û–†–ú–ê –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –û–¶–ï–ù–û–ö ----------------
if (table === 'grades') {

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö 3 —Ç–∞–±–ª–∏—Ü / –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
    const [students, courses, semesters] = await Promise.all([
        fetch('/api/students').then(r => r.json()),
        fetch('/api/courses').then(r => r.json()),
        fetch('/api/semesters').then(r => r.json())
    ]);

    // ---------- –°–ü–ò–°–û–ö –°–¢–£–î–ï–ù–¢–û–í ----------
    let studOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>`;
    students.forEach(s => {
        const text = `${s.last_name} ${s.first_name}${s.pytronimic ? " " + s.pytronimic : ""}`;
        studOptions += `<option value="${s.student_id}">${text}</option>`;
    });

    // ---------- –°–ü–ò–°–û–ö –ö–£–†–°–û–í ----------
    let courseOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>`;
    courses.forEach(c => {
        courseOptions += `<option value="${c.course_id}">${c.title}</option>`;
    });

    // ---------- –°–ü–ò–°–û–ö –°–ï–ú–ï–°–¢–†–û–í (–∏–∑ VIEW) ----------
    let semOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ—Å—Ç—Ä --</option>`;
    semesters.forEach(se => {
        semOptions += `<option value="${se.semester_id}">${se.name}</option>`;
    });

    // ---------- –°–ë–û–†–ö–ê –§–û–†–ú–´ ----------
    formFields.innerHTML = `
        <label>
            –°—Ç—É–¥–µ–Ω—Ç:
            <select name="student_id" required>
                ${studOptions}
            </select>
        </label>

        <label>
            –ö—É—Ä—Å:
            <select name="course_id" required>
                ${courseOptions}
            </select>
        </label>

        <label>
            –°–µ–º–µ—Å—Ç—Ä:
            <select name="name" required>
                ${semOptions}
            </select>
        </label>

        <label>
            –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:
            <input type="number" name="final_grade" step="0.1" required>
        </label>
    `;

    return;
}

  return Promise.resolve();
}

/* ---------- submit modal ---------- */
modalForm.onsubmit = async (e)=>{
  e.preventDefault();
  formError.textContent = '';
  const obj = Object.fromEntries(new FormData(modalForm).entries());

  // convert numeric fields
  if(activeTable==='courses' && obj.credits) obj.credits = Number(obj.credits);
  if(activeTable==='courses' && obj.lecturer_id==='') obj.lecturer_id = null;
  if(activeTable==='grades'){
    obj.student_id = Number(obj.student_id);
    obj.course_id = Number(obj.course_id);
    obj.final_grade = Number(obj.final_grade);
  }

  try{
    if(editId){
      const res = await fetch(`/api/${activeTable}/${editId}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!res.ok) throw new Error('Save error');
    } else {
      const res = await fetch(`/api/${activeTable}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!res.ok) throw new Error('Create error');
    }
    closeModal();
    await loadData(activeTable);
  }catch(err){
    console.error(err);
    formError.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
  }
};

/* ---------- init ---------- */
loadData(activeTable);
loadStudentList();// ‚Üê –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ "–°—Ç—É–¥–µ–Ω—Ç"


// loadStudentStats(); 


// ---- –ü–û–ö–ê–ó –ü–û–ò–°–ö–ê –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í ----
const searchBlock = document.getElementById("student-search");
if (activeTable === "students") {
    searchBlock.style.display = "block";
} else {
    searchBlock.style.display = "none";
}

document.getElementById("studentSearchInput")
    .addEventListener("input", filterStudentsTable);

function filterStudentsTable() {
    const text = document.getElementById("studentSearchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#students tbody tr");

    rows.forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(text) ? "" : "none";
    });
}


// /* ---------------- –ê–õ–§–ê–í–ò–¢–ù–´–ô –§–ò–õ–¨–¢–† ---------------- */

// const letters = "–ê–ë–í–ì–î–ï–Å–ñ–ó–ò–ô–ö–õ–ú–ù–û–ü–†–°–¢–£–§–•–¶–ß–®–©–≠–Æ–Ø".split("");

// function createLetterButtons() {
//     const wrap = document.getElementById("letter-filter");
//     wrap.innerHTML = "";
//     letters.forEach(l => {
//         const btn = document.createElement("button");
//         btn.textContent = l;
//         btn.onclick = () => filterLecturersByLetter(l);
//         wrap.appendChild(btn);
//     });

//     // –∫–Ω–æ–ø–∫–∞ "–°–±—Ä–æ—Å"
//     const reset = document.createElement("button");
//     reset.textContent = "–°–±—Ä–æ—Å";
//     reset.style.marginLeft = "10px";
//     reset.onclick = () => loadData("lecturers");
//     wrap.appendChild(reset);
// }

// createLetterButtons();

// function filterLecturersByLetter(letter) {
//     const rows = document.querySelectorAll("#lecturers tbody tr");
//     rows.forEach(row => {
//         const lastName = row.children[2].innerText.trim().toUpperCase(); // –§–∞–º–∏–ª–∏—è = 3-–π —Å—Ç–æ–ª–±–µ—Ü
//         row.style.display = lastName.startsWith(letter) ? "" : "none";
//     });
// }

/* ---------------- –§–ò–õ–¨–¢–† –ü–û –î–ê–¢–ï ---------------- */
function normalizeDate(dateStr) {
    if (!dateStr) return "";

    // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç DD.MM.YYYY
    if (dateStr.includes(".")) {
        const [d, m, y] = dateStr.split(".");
        return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç YYYY/MM/DD
    if (dateStr.includes("/")) {
        const [y, m, d] = dateStr.split("/");
        return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    // –ï—Å–ª–∏ —É–∂–µ YYYY-MM-DD
    if (dateStr.includes("-")) {
        const [y, m, d] = dateStr.split("-");
        return `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    return dateStr;
}

// /* ---------------- –ü–û–ò–°–ö –ü–û –ö–ê–§–ï–î–†–ï ---------------- */

// document.getElementById("departmentSearchInput")
//     .addEventListener("input", function () {
//         const val = this.value.toLowerCase();
//         const rows = document.querySelectorAll("#lecturers tbody tr");

//         rows.forEach(r => {
//             const dept = r.children[5].innerText.toLowerCase(); // –∫–∞—Ñ–µ–¥—Ä–∞ = 6-–π —Å—Ç–æ–ª–±–µ—Ü
//             r.style.display = dept.includes(val) ? "" : "none";
//         });
//     });



/* ------------------- –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –°–¢–£–î–ï–ù–¢–û–í ------------------- */
async function loadStudentList() {
    const sel = document.getElementById("student-select");
    sel.innerHTML = `<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>`;

    const res = await fetch("/api/students");
    const students = await res.json();

    sel.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>`;
    students.forEach(s => {
        sel.innerHTML += `<option value="${s.student_id}">
            ${s.last_name} ${s.first_name}
        </option>`;
    });
}

/* ------------------- –ó–ê–ì–†–£–ó–ö–ê –£–°–ü–ï–í–ê–ï–ú–û–°–¢–ò ------------------- */
async function loadStudentStats() {
    const studentId = document.getElementById("student-select").value;
    const output = document.getElementById("student-stats");

    if (!studentId) {
        output.innerHTML = "<p style='color:red;'>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞!</p>";
        return;
    }

    output.innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

    try {
        const res = await fetch(`/api/student-stats/${studentId}`);
        if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞");

        const data = await res.json();
        output.innerHTML = "";

        if (data.length === 0) {
            output.innerHTML = "<p>–£ —Å—Ç—É–¥–µ–Ω—Ç–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏.</p>";
            return;
        }

        // ---------- –¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç–∏ ----------
        let html = `
            <h3>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h3>
            <table>
                <thead>
                    <tr>
                        <th>–ö—É—Ä—Å</th>
                        <th>–°–µ–º–µ—Å—Ç—Ä</th>
                        <th>–û—Ü–µ–Ω–∫–∞</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach(rec => {
            html += `
                <tr>
                    <td>${rec.course_title}</td>
                    <td>${rec.semester}</td>
                    <td>${rec.final_grade}</td>
                </tr>
            `;
        });

        html += "</tbody></table>";
        output.innerHTML = html;

        // ---------- –ì–†–ê–§–ò–ö ----------
        drawStudentChart(data);

    } catch (err) {
        output.innerHTML = "<p style='color:red;'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>";
        console.error(err);
    }
}

/* ------------------- –ì–†–ê–§–ò–ö ------------------- */
let studentChart = null;

function drawStudentChart(data) {
    const ctx = document.getElementById("studentChart").getContext("2d");

    if (studentChart) studentChart.destroy();

    studentChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => d.course_title),
            datasets: [{
                label: "–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞",
                data: data.map(d => d.final_grade),
                borderWidth: 3,
                borderColor: "#4caf50",
                tension: 0.3
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
}




// ----------------- —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥: student stats -----------------

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ —Å–µ–ª–µ–∫—Ç (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏)
async function populateStudentSelect() {
  const sel = document.getElementById('student-select');
  if (!sel) return;
  sel.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
  try {
    const res = await fetch('/api/students');
    if (!res.ok) throw new Error('students fetch ' + res.status);
    const students = await res.json();
    sel.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>';
    students.forEach(s => {
      const name = `${s.last_name || ''} ${s.first_name || ''}`.trim();
      const opt = document.createElement('option');
      opt.value = s.student_id;
      opt.textContent = `${name} (ID:${s.student_id})`;
      sel.appendChild(opt);
    });
  } catch (err) {
    console.error('populateStudentSelect error', err);
    sel.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç—É–¥–µ–Ω—Ç—É
async function loadStudentStats() {
  const sel = document.getElementById('student-select');
  const out = document.getElementById('student-stats');
  const canvas = document.getElementById('studentChart');
  if (!sel || !out || !canvas) { console.error('DOM elements missing'); return; }

  const sid = sel.value;
  if (!sid) { out.innerHTML = '<p style="color:crimson">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞.</p>'; clearCanvas(canvas); return; }

  out.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>'; clearCanvas(canvas);

  try {
    // –ó–∞–ø—Ä–∞—Å—ã–≤–∞–µ–º backend –º–∞—Ä—à—Ä—É—Ç, –∫–æ—Ç–æ—Ä—ã–π –º—ã –¥–æ–±–∞–≤–∏–ª–∏
    const res = await fetch(`/api/grades/student/${sid}`);
    if (!res.ok) throw new Error('student-stats fetch ' + res.status);
    const grades = await res.json();

    if (!grades || grades.length === 0) {
      out.innerHTML = '<p>–û—Ü–µ–Ω–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
      document.getElementById('downloadStatsBtn').style.display = 'none';
      return;
    }

    // –†–µ–Ω–¥–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
    let html = '<h3>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å</h3><table><thead><tr><th>–ö—É—Ä—Å</th><th>–°–µ–º–µ—Å—Ç—Ä</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–∞—Ç–∞</th></tr></thead><tbody>';
    grades.forEach(g => {
      html += `<tr>
                <td>${escapeHtml(g.course_title || ('–ö—É—Ä—Å ' + (g.course_id||'')))}</td>
                <td>${escapeHtml(g.semester || '')}</td>
                <td>${escapeHtml(g.final_grade == null ? '' : g.final_grade)}</td>
                <td>${escapeHtml(g.created_at ? new Date(g.created_at).toLocaleString() : '')}</td>
               </tr>`;
    });
    html += '</tbody></table>';
    out.innerHTML = html;

    // –°–æ—Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏ –≥—Ä–∞—Ñ–∏–∫–∞
    window._currentStudentStats = { studentId: sid, grades };

    // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∞—Ñ–∏–∫: —É—Å—Ä–µ–¥–Ω–∏–º –æ—Ü–µ–Ω–∫–∏ –ø–æ –∫—É—Ä—Å–∞–º (–µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π –ø–æ –∫—É—Ä—Å—É)
    const byCourse = {};
    grades.forEach(g => {
      const course = g.course_title || ('–ö—É—Ä—Å ' + (g.course_id || ''));
      const val = Number(g.final_grade);
      if (!byCourse[course]) byCourse[course] = { sum: 0, cnt: 0 };
      if (!isNaN(val)) { byCourse[course].sum += val; byCourse[course].cnt += 1; }
    });
    const labels = [], values = [];
    Object.keys(byCourse).forEach(course => {
      const o = byCourse[course];
      labels.push(course);
      values.push(o.cnt ? +(o.sum / o.cnt).toFixed(2) : 0);
    });

    drawBarChart(canvas, labels, values);
    document.getElementById('downloadStatsBtn').style.display = 'inline-block';
  } catch (err) {
    console.error('loadStudentStats error', err);
    out.innerHTML = '<p style="color:crimson">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>';
    document.getElementById('downloadStatsBtn').style.display = 'none';
  }
}

// –°–∫–∞—á–∞—Ç—å CSV (—Ç–µ–∫—É—â–∏–µ grades –≤ window._currentStudentStats)
function downloadStudentCSV() {
  const data = window._currentStudentStats;
  if (!data || !data.grades) { alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è'); return; }
  let csv = '–ö—É—Ä—Å;–°–µ–º–µ—Å—Ç—Ä;–û—Ü–µ–Ω–∫–∞;–î–∞—Ç–∞\n';
  data.grades.forEach(g => {
    const course = (g.course_title || '').replace(/;/g,',');
    const sem = (g.semester || '').replace(/;/g,',');
    const date = g.created_at ? (new Date(g.created_at)).toISOString() : '';
    csv += `${course};${sem};${g.final_grade};${date}\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `uspev_${data.studentId}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Utility
function escapeHtml(s){ return String(s===null||s===undefined?'':s)
  .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function clearCanvas(canvas){
  try{ const ctx = canvas.getContext('2d'); ctx.clearRect(0,0,canvas.width,canvas.height); }catch(e){}
}

// –ü—Ä–æ—Å—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –Ω–∞ canvas (bar chart)
function drawBarChart(canvas, labels, values){
  const ctx = canvas.getContext('2d');
  // responsive
  const ratio = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.round(rect.width * ratio);
  canvas.height = Math.round((rect.height || 260) * ratio);
  ctx.setTransform(1,0,0,1,0,0); // reset transform
  ctx.scale(ratio, ratio);
  ctx.clearRect(0,0,rect.width,rect.height);

  if (!labels || labels.length === 0) {
    ctx.fillStyle = '#666'; ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞', 10, 20); return;
  }

  const padding = 40;
  const chartW = rect.width - padding*2;
  const chartH = rect.height - padding*2;
  const maxVal = Math.max(...values, 1);
  const n = values.length;
  const colFull = chartW / n;
  const barW = colFull * 0.6;
  const gap = colFull * 0.4;

  // axes
  ctx.strokeStyle = '#333';
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, padding + chartH);
  ctx.lineTo(padding + chartW, padding + chartH);
  ctx.stroke();

  ctx.font = '12px Arial';
  for (let i=0;i<n;i++){
    const v = values[i];
    const x = padding + i*(barW+gap) + gap/2;
    const h = (v / maxVal) * (chartH - 10);
    const y = padding + chartH - h;
    ctx.fillStyle = '#4caf50';
    ctx.fillRect(x, y, barW, h);
    ctx.fillStyle = '#000';
    ctx.fillText(String(v), x, y - 6);
    // label
    ctx.save();
    ctx.translate(x + barW/2, padding + chartH + 14);
    ctx.rotate(-Math.PI/6);
    ctx.textAlign = 'right';
    ctx.fillText(labels[i], 0, 0);
    ctx.restore();
  }
}


/* ==========================================================
   –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ö–õ–ê–î–û–ö
========================================================== */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        document.querySelectorAll(".table-block, #student-panel")
            .forEach(b => b.classList.add("hidden"));

        const target = tab.dataset.target;
        const block = document.getElementById(target);
        if (block) block.classList.remove("hidden");

        if (target === "student-panel") loadStudentList();
    });
});


/* ==========================================================
   1. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –°–¢–£–î–ï–ù–¢–û–í
========================================================== */
async function loadStudentList() {
    const sel = document.getElementById("stat-student-select");
    sel.innerHTML = `<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>`;
    document.getElementById("course-block").classList.add("hidden");
    document.getElementById("prediction-result").innerHTML = "";

    const res = await fetch("/api/students");
    const students = await res.json();

    sel.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>`;
    students.forEach(s => {
        sel.innerHTML += `<option value="${s.student_id}">
            ${s.last_name} ${s.first_name}
        </option>`;
    });

    sel.onchange = onStudentSelected;
}


/* ==========================================================
   2. –ü–û–°–õ–ï –í–´–ë–û–†–ê –°–¢–£–î–ï–ù–¢–ê ‚Üí –ü–û–î–ì–†–£–ñ–ê–ï–ú –ö–£–†–°–´ –ë–ï–ó –û–¶–ï–ù–û–ö
========================================================== */
async function onStudentSelected() {
    const id = this.value;
    const courseSel = document.getElementById("stat-course-select");
    const block = document.getElementById("course-block");
    const resultBox = document.getElementById("prediction-result");

    courseSel.innerHTML = "<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>";
    resultBox.innerHTML = "";
    block.classList.add("hidden");

    if (!id) return;

    // –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–æ–≤
    const allCourses = await (await fetch("/api/courses")).json();

    // –ø–æ–ª—É—á–∞–µ–º –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
    const grades = await (await fetch(`/api/grades/student/${id}`)).json();

    const learnedIds = new Set(grades.map(g => Number(g.course_id)));

    const available = allCourses.filter(c => !learnedIds.has(Number(c.course_id)));

    courseSel.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç --</option>`;
    available.forEach(c => {
        courseSel.innerHTML += `<option value="${c.course_id}">${c.title}</option>`;
    });

    block.classList.remove("hidden");
}


/* ==========================================================
   3. –ü–†–û–ì–ù–û–ó
========================================================== */

document.getElementById("makePredictionBtn").onclick = makePrediction;

async function makePrediction() {
    const studentId = document.getElementById("stat-student-select").value;
    const courseId = document.getElementById("stat-course-select").value;
    const resultBox = document.getElementById("prediction-result");

    if (!studentId) {
        resultBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞.";
        return;
    }
    if (!courseId) {
        resultBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.";
        return;
    }

    resultBox.textContent = "–†–∞—Å—á—ë—Ç...";

    // –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
    const grades = await (await fetch(`/api/grades/student/${studentId}`)).json();
    const numeric = grades.map(g => Number(g.final_grade)).filter(v => !isNaN(v));

    if (numeric.length === 0) {
        resultBox.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.";
        return;
    }

    const avg = numeric.reduce((a,b)=>a+b,0) / numeric.length;

    // –ø—Ä–æ—Å—Ç–æ–π —Ç—Ä–µ–Ω–¥ (—Ä–∞–∑–Ω–æ—Å—Ç–Ω–∞—è)
    let trend = 0;
    for (let i=1;i<numeric.length;i++) trend += numeric[i]-numeric[i-1];
    trend /= numeric.length || 1;

    let predicted = avg + trend;
    predicted = Math.max(0, Math.min(100, predicted));

    resultBox.innerHTML = `
        <b>–û–∂–∏–¥–∞–µ–º–∞—è –æ—Ü–µ–Ω–∫–∞:</b> 
        <span style="color:green; font-size:22px;">
            ${predicted.toFixed(1)} / 100
        </span>
    `;

    drawChart(grades);
}


/* ==========================================================
   4. –ì–†–ê–§–ò–ö
========================================================== */
let chart = null;

function drawChart(data) {
    const ctx = document.getElementById("studentChart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => d.course_title),
            datasets: [{
                label: "–û—Ü–µ–Ω–∫–∏",
                data: data.map(d => d.final_grade),
                borderColor: "#4caf50",
                borderWidth: 2
            }]
        }
    });
}

</script>
</body>
</html>
