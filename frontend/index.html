<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
body{font-family:Arial;margin:0;padding:20px;background:#f5f5f5}
h1{text-align:center}
.tabs{display:flex;gap:10px;justify-content:center;margin-bottom:20px}
.tab{padding:10px 20px;background:#e0e0e0;border-radius:8px;cursor:pointer}
.tab.active{background:#4caf50;color:#fff}
table{width:100%;border-collapse:collapse;background:#fff;margin-bottom:20px}
th,td{border:1px solid #ccc;padding:8px;text-align:left}
th{background:#e0e0e0}
.hidden{display:none}
button.action-btn{margin-right:5px}
#modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center}
#modal .modal-content{background:#fff;padding:20px;border-radius:8px;width:420px;max-width:90%}
#modal label{display:block;margin-top:10px}
#modal input,#modal select{width:100%;padding:6px;margin-top:5px;box-sizing:border-box}
#modal .buttons{text-align:right;margin-top:12px}
.error{color:red}
</style>
</head>
<body>
<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</h1>

<div class="tabs">
  <div class="tab active" data-target="students">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
  <div class="tab" data-target="lecturers">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</div>
  <div class="tab" data-target="courses">–ö—É—Ä—Å—ã</div>
  <div class="tab" data-target="grades">–û—Ü–µ–Ω–∫–∏</div>
</div>

<div id="student-search" style="margin: 10px 0; display:none;">
    <input type="text" id="studentSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏–∏..." />
 </div>

<table id="students" class="table-block">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–û—Ç—á–µ—Å—Ç–≤–æ</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
</table>

  <table id="lecturers" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ö–∞—Ñ–µ–¥—Ä–∞</th><th>–ü—Ä–∏–Ω—è—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="courses" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ö—Ä–µ–¥–∏—Ç—ã</th><th>–ö–∞—Ñ–µ–¥—Ä–∞</th><th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="grades" class="table-block hidden">
    <thead><tr><th>ID</th><th>–°—Ç—É–¥–µ–Ω—Ç (—Ñ–∞–º–∏–ª–∏—è)</th><th>–ö—É—Ä—Å</th><th>–°–µ–º–µ—Å—Ç—Ä</th><th>–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</th><th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal -->
<div id="modal">
  <div class="modal-content">
    <h3 id="modal-title">–î–æ–±–∞–≤–∏—Ç—å</h3>
    <form id="modal-form">
      <div id="form-fields"></div>
      <div class="error" id="form-error"></div>
      <div class="buttons">
        <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

<script>
/* ---------- state ---------- */
const tabs = document.querySelectorAll('.tab');
const tables = document.querySelectorAll('.table-block');
let activeTable = 'students';
let editId = null;

/* helper to get primary key field name for each table */
function getIdKey(table){
  switch(table){
    case 'students': return 'student_id';
    case 'lecturers': return 'lecturer_id';
    case 'courses': return 'course_id';
    case 'grades': return 'grade_id';
    default: return 'id';
  }
}

/* ---------- tabs handling ---------- */
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTable = tab.dataset.target;
    tables.forEach(tbl=>tbl.classList.add('hidden'));
    document.getElementById(activeTable).classList.remove('hidden');
    loadData(activeTable);
      // ---- –ü–û–ö–ê–ó –ü–û–ò–°–ö–ê –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í ----
    const searchBlock = document.getElementById("student-search");
    if (activeTable === "students") {
        searchBlock.style.display = "block";
    } else {
        searchBlock.style.display = "none";
    }
  });
});

/* ---------- load data ---------- */
async function loadData(table){
  try{
    const res = await fetch(`/api/${table}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderTable(table, data);
  }catch(err){
    console.error(err);
    const tbody = document.querySelector(`#${table} tbody`);
    tbody.innerHTML = `<tr><td colspan="20" class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>`;
  }
}

/* ---------- renderers for each table (explicit columns) ---------- */
function renderTable(table, rows){
  const tbody = document.querySelector(`#${table} tbody`);
  tbody.innerHTML = '';

  if(!Array.isArray(rows) || rows.length===0){
    tbody.innerHTML = `<tr><td colspan="20">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    // for students/lecturers/courses allow add button row even if empty
    if(table !== 'grades') appendAddRow(table, tbody);
    return;
  }

  if(table==='students'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.student_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.pytronimic || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.birth_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('students', ${r.student_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('students', ${r.student_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='lecturers'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.lecturer_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.hire_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('lecturers', ${r.lecturer_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('lecturers', ${r.lecturer_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='courses'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.course_id}</td>
        <td>${r.title || ''}</td>
        <td>${r.description || ''}</td>
        <td>${r.credits || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.lecturer_last_name || (r.lecturer_id || '')}</td>
        <td>
          <button class="action-btn" onclick="openModal('courses', ${r.course_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('courses', ${r.course_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='grades'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.grade_id}</td>
        <td>${r.student_last_name || ''}</td>
        <td>${r.course_title || ''}</td>
        <td>${r.semester || ''}</td>
        <td>${r.final_grade || ''}</td>
        <td>${r.created_at || ''}</td>`;
      tbody.appendChild(tr);
    });
    // no add/edit/delete row appended here? We might allow add ‚Äî keep add option:
    appendAddRow(table, tbody, true); // allow add for grades but no edit/delete in rows
    return;
  }
}

/* add-row: creates a full-width row with "Add" button; if forGradesAddOnlyOnly flag */
function appendAddRow(table, tbody, gradesAddOnly=false){
  const tr = document.createElement('tr');
  const colCount = tbody.parentElement.querySelector('thead tr').children.length;
  const td = document.createElement('td');
  td.colSpan = colCount;
  if(table==='grades') {
    td.innerHTML = `<button onclick="openModal('grades')">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>`;
  } else {
    td.innerHTML = `<button onclick="openModal('${table}')">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
  }
  tr.appendChild(td);
  tbody.appendChild(tr);
}

/* ---------- CRUD actions ---------- */
async function deleteRow(table, id){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ID=${id} –∏–∑ ${table}?`)) return;
  try{
    const res = await fetch(`/api/${table}/${id}`, { method:'DELETE' });
    if(!res.ok) throw new Error('Delete error');
    await loadData(table);
  }catch(err){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); console.error(err); }
}

/* ---------- Modal logic ---------- */
const modal = document.getElementById('modal');
const modalForm = document.getElementById('modal-form');
const formFields = document.getElementById('form-fields');
const modalTitle = document.getElementById('modal-title');
const formError = document.getElementById('form-error');

function openModal(table, id=null){
  editId = id;
  modalTitle.textContent = id ? `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ${table}` : `–î–æ–±–∞–≤–∏—Ç—å –≤ ${table}`;
  formError.textContent = '';
  formFields.innerHTML = '';

  // build fields depending on table; if editId set, fetch item to prefill
  if(editId){
    // fetch existing record to prefill
    fetch(`/api/${table}/${editId}`).then(r=>r.json()).then(item=>{
      buildFields(table, item);
      modal.style.display = 'flex';
    }).catch(err=>{
      console.error(err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    });
  } else {
    buildFields(table, null).then(()=> modal.style.display = 'flex');
  }
}

function closeModal(){ modal.style.display = 'none'; editId = null; modalForm.reset(); }

window.onclick = (e)=>{ if(e.target===modal) closeModal(); }

async function buildFields(table, item){
  // returns a Promise because we may fetch lists for selects
  formFields.innerHTML = '';
  if(table==='students'){
    formFields.innerHTML += `<label>–ò–º—è:<input name="first_name" value="${item?.first_name || ''}" required></label>`;
    formFields.innerHTML += `<label>–û—Ç—á–µ—Å—Ç–≤–æ:<input name="middle_name" value="${item?.middle_name || ''}"></label>`;
    formFields.innerHTML += `<label>–§–∞–º–∏–ª–∏—è:<input name="last_name" value="${item?.last_name || ''}" required></label>`;
    formFields.innerHTML += `<label>Email:<input name="email" type="email" value="${item?.email || ''}"></label>`;
    formFields.innerHTML += `<label>–¢–µ–ª–µ—Ñ–æ–Ω:<input name="phone_number" value="${item?.phone_number || ''}"></label>`;
    formFields.innerHTML += `<label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:<input name="birth_date" placeholder="YYYY-MM-DD" value="${item?.birth_date || ''}"></label>`;
    return Promise.resolve();
  }

  if(table==='lecturers'){
    formFields.innerHTML += `<label>–ò–º—è:<input name="first_name" value="${item?.first_name || ''}" required></label>`;
    formFields.innerHTML += `<label>–§–∞–º–∏–ª–∏—è:<input name="last_name" value="${item?.last_name || ''}" required></label>`;
    formFields.innerHTML += `<label>Email:<input name="email" type="email" value="${item?.email || ''}"></label>`;
    formFields.innerHTML += `<label>–¢–µ–ª–µ—Ñ–æ–Ω:<input name="phone_number" value="${item?.phone_number || ''}"></label>`;
    formFields.innerHTML += `<label>–ö–∞—Ñ–µ–¥—Ä–∞:<input name="department" value="${item?.department || ''}"></label>`;
    formFields.innerHTML += `<label>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:<input name="hire_date" placeholder="YYYY-MM-DD" value="${item?.hire_date || ''}"></label>`;
    return Promise.resolve();
  }

  if(table==='courses'){
    // need lecturers list for select
    const lecturers = await fetch('/api/lecturers').then(r=>r.json());
    let options = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>`;
    lecturers.forEach(l => {
      const selected = item && (l.lecturer_id === item.lecturer_id) ? 'selected' : '';
      options += `<option value="${l.lecturer_id}" ${selected}>${l.last_name} (${l.first_name})</option>`;
    });
    formFields.innerHTML += `<label>–ù–∞–∑–≤–∞–Ω–∏–µ:<input name="title" value="${item?.title || ''}" required></label>`;
    formFields.innerHTML += `<label>–û–ø–∏—Å–∞–Ω–∏–µ:<input name="description" value="${item?.description || ''}"></label>`;
    formFields.innerHTML += `<label>–ö—Ä–µ–¥–∏—Ç—ã:<input name="credits" type="number" value="${item?.credits || ''}"></label>`;
    formFields.innerHTML += `<label>–ö–∞—Ñ–µ–¥—Ä–∞:<input name="department" value="${item?.department || ''}"></label>`;
    formFields.innerHTML += `<label>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å:<select name="lecturer_id">${options}</select></label>`;
    return;
  }

  // ---------------- –§–û–†–ú–ê –î–õ–Ø –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –û–¶–ï–ù–û–ö ----------------
if (table === 'grades') {

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –≤—Å–µ—Ö 3 —Ç–∞–±–ª–∏—Ü / –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
    const [students, courses, semesters] = await Promise.all([
        fetch('/api/students').then(r => r.json()),
        fetch('/api/courses').then(r => r.json()),
        fetch('/api/semesters').then(r => r.json())
    ]);

    // ---------- –°–ü–ò–°–û–ö –°–¢–£–î–ï–ù–¢–û–í ----------
    let studOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>`;
    students.forEach(s => {
        const text = `${s.last_name} ${s.first_name}${s.pytronimic ? " " + s.pytronimic : ""}`;
        studOptions += `<option value="${s.student_id}">${text}</option>`;
    });

    // ---------- –°–ü–ò–°–û–ö –ö–£–†–°–û–í ----------
    let courseOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å --</option>`;
    courses.forEach(c => {
        courseOptions += `<option value="${c.course_id}">${c.title}</option>`;
    });

    // ---------- –°–ü–ò–°–û–ö –°–ï–ú–ï–°–¢–†–û–í (–∏–∑ VIEW) ----------
    let semOptions = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ–º–µ—Å—Ç—Ä --</option>`;
    semesters.forEach(se => {
        semOptions += `<option value="${se.semester_id}">${se.name}</option>`;
    });

    // ---------- –°–ë–û–†–ö–ê –§–û–†–ú–´ ----------
    formFields.innerHTML = `
        <label>
            –°—Ç—É–¥–µ–Ω—Ç:
            <select name="student_id" required>
                ${studOptions}
            </select>
        </label>

        <label>
            –ö—É—Ä—Å:
            <select name="course_id" required>
                ${courseOptions}
            </select>
        </label>

        <label>
            –°–µ–º–µ—Å—Ç—Ä:
            <select name="name" required>
                ${semOptions}
            </select>
        </label>

        <label>
            –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:
            <input type="number" name="final_grade" step="0.1" required>
        </label>
    `;

    return;
}

  return Promise.resolve();
}

/* ---------- submit modal ---------- */
modalForm.onsubmit = async (e)=>{
  e.preventDefault();
  formError.textContent = '';
  const obj = Object.fromEntries(new FormData(modalForm).entries());

  // convert numeric fields
  if(activeTable==='courses' && obj.credits) obj.credits = Number(obj.credits);
  if(activeTable==='courses' && obj.lecturer_id==='') obj.lecturer_id = null;
  if(activeTable==='grades'){
    obj.student_id = Number(obj.student_id);
    obj.course_id = Number(obj.course_id);
    obj.final_grade = Number(obj.final_grade);
  }

  try{
    if(editId){
      const res = await fetch(`/api/${activeTable}/${editId}`, {
        method:'PUT',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!res.ok) throw new Error('Save error');
    } else {
      const res = await fetch(`/api/${activeTable}`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(obj)
      });
      if(!res.ok) throw new Error('Create error');
    }
    closeModal();
    await loadData(activeTable);
  }catch(err){
    console.error(err);
    formError.textContent = '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ.';
  }
};

/* ---------- init ---------- */
loadData(activeTable);

// ---- –ü–û–ö–ê–ó –ü–û–ò–°–ö–ê –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í ----
const searchBlock = document.getElementById("student-search");
if (activeTable === "students") {
    searchBlock.style.display = "block";
} else {
    searchBlock.style.display = "none";
}

document.getElementById("studentSearchInput")
    .addEventListener("input", filterStudentsTable);

function filterStudentsTable() {
    const text = document.getElementById("studentSearchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#students tbody tr");

    rows.forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(text) ? "" : "none";
    });
}



</script>
</body>
</html>
