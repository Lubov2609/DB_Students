<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç ‚Äî –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</title>
<style>
    body { font-family: Arial; padding: 20px; background: #f5f5f5; }
    .tabs { display:flex; gap:10px; margin-bottom:20px; }
    .tab { background:#ddd; padding:10px 20px; border-radius:8px; cursor:pointer; }
    .tab.active { background:#4caf50; color:white; }
    .hidden { display:none; }
    table { width:100%; border-collapse:collapse; background:white; margin-top:20px; }
    th,td { border:1px solid #ccc; padding:8px; }
</style>
</head>
<body>

<h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞</h1>

<div class="tabs">
    <div class="tab active" data-target="students">–°—Ç—É–¥–µ–Ω—Ç—ã</div>
    <div class="tab" data-target="lecturers">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</div>
    <div class="tab" data-target="courses">–ö—É—Ä—Å—ã</div>
    <div class="tab" data-target="grades">–û—Ü–µ–Ω–∫–∏</div>
    <div class="tab" data-target="student-panel">–°—Ç—É–¥–µ–Ω—Ç</div>
</div>


<div id="student-search" style="margin: 10px 0; display:none;">
    <input type="text" id="studentSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ñ–∞–º–∏–ª–∏–∏..." />
 </div>

<table id="students" class="table-block">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–û—Ç—á–µ—Å—Ç–≤–æ</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
</table>
<div id="lecturer-search" class="hidden" style="margin: 12px 0; display:flex; flex-direction: column; gap:10px;">
    
    <!-- –ê–ª—Ñ–∞–≤–∏—Ç–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä -->
    <!-- <div id="letter-filter" style="display:flex; flex-wrap:wrap; gap:5px;"></div> -->

    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ -->
<!-- <div id="lecturer-search" style="display:flex; gap:10px;">
        <button onclick="sortLecturersByDate('asc')">üìÖ –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</button>
        <button onclick="sortLecturersByDate('desc')">üìÖ –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</button>
 </div> -->
    <!-- –ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ñ–µ–¥—Ä–µ -->
    <!-- <input type="text" id="departmentSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ñ–µ–¥—Ä–µ..." />
</div> -->
  <table id="lecturers" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ò–º—è</th><th>–§–∞–º–∏–ª–∏—è</th><th>Email</th><th>–¢–µ–ª–µ—Ñ–æ–Ω</th><th>–ö–∞—Ñ–µ–¥—Ä–∞</th><th>–ü—Ä–∏–Ω—è—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="courses" class="table-block hidden">
    <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–û–ø–∏—Å–∞–Ω–∏–µ</th><th>–ó–∞—á—ë—Ç–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã</th><th>–î–∏—Å—Ü–∏–ø–ª–∏–Ω—ã</th><th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>

  <table id="grades" class="table-block hidden">
    <thead><tr><th>ID</th><th>–°—Ç—É–¥–µ–Ω—Ç (—Ñ–∞–º–∏–ª–∏—è)</th><th>–ö—É—Ä—Å</th><th>–°–µ–º–µ—Å—Ç—Ä</th><th>–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞</th><th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- =================== –í–ö–õ–ê–î–ö–ê –°–¢–£–î–ï–ù–¢ =================== -->

<div id="student-panel" class="hidden" style="padding:20px;">
    <h2>–£—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>

    <label>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞:</label><br>
    <select id="stat-student-select" style="padding:5px; width:300px; margin:10px 0;">
        <option value="">-- –°—Ç—É–¥–µ–Ω—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω --</option>
    </select>

    <div id="course-block" class="hidden">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –Ω–µ—Ç –æ—Ü–µ–Ω–∫–∏:</label><br>
        <select id="stat-course-select" style="padding:5px; width:300px; margin:10px 0;">
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç --</option>
        </select>

        <button id="makePredictionBtn"
                style="padding:6px 12px; background:#673ab7; color:white;">
            –°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
        </button>
    </div>

    <div id="prediction-result" style="margin-top:20px; font-size:18px;"></div>

    <canvas id="studentChart" width="800" height="400" style="margin-top:30px;"></canvas>
</div>

<!-- ===== –°–Æ–î–ê –ø–æ–¥—Å—Ç–∞–≤–∏—à—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ (students, lecturers, courses, grades) ===== -->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>


/* ---------- state ---------- */
const tabs = document.querySelectorAll('.tab');
const tables = document.querySelectorAll('.table-block');
let activeTable = 'students';
let editId = null;

/* helper to get primary key field name for each table */
function getIdKey(table){
  switch(table){
    case 'students': return 'student_id';
    case 'lecturers': return 'lecturer_id';
    case 'courses': return 'course_id';
    case 'grades': return 'grade_id';
    case "student-panel":      // ‚Üê –î–û–ë–ê–í–ò–¢–¨
        loadStudentList();     // ‚Üê –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        break;
    default: return 'id';
  }
}

/* ---------- tabs handling ---------- */
tabs.forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activeTable = tab.dataset.target;
    tables.forEach(tbl=>tbl.classList.add('hidden'));
    document.getElementById(activeTable).classList.remove('hidden');
    loadData(activeTable);
      // ---- –ü–û–ö–ê–ó –ü–û–ò–°–ö–ê –î–õ–Ø –°–¢–£–î–ï–ù–¢–û–í ----
    const searchBlock = document.getElementById("student-search");
    if (activeTable === "students") {
        searchBlock.style.display = "block";
    } else {
        searchBlock.style.display = "none";
    }
    // –§–∏–ª—å—Ç—Ä—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π
const lectFilter = document.getElementById("lecturer-search");
if (activeTable === "lecturers") {
    lectFilter.classList.remove("hidden");
} else {
    lectFilter.classList.add("hidden");
}
  });
});

/* ---------- load data ---------- */
async function loadData(table){
  try{
    const res = await fetch(`/api/${table}`);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    renderTable(table, data);
  }catch(err){
    console.error(err);
    const tbody = document.querySelector(`#${table} tbody`);
    tbody.innerHTML = `<tr><td colspan="20" class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</td></tr>`;
  }
}

/* ---------- renderers for each table (explicit columns) ---------- */
function renderTable(table, rows){
  const tbody = document.querySelector(`#${table} tbody`);
  tbody.innerHTML = '';

  if(!Array.isArray(rows) || rows.length===0){
    tbody.innerHTML = `<tr><td colspan="20">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
    // for students/lecturers/courses allow add button row even if empty
    if(table !== 'grades') appendAddRow(table, tbody);
    return;
  }

  if(table==='students'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.student_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.pytronimic || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.birth_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('students', ${r.student_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('students', ${r.student_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='lecturers'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.lecturer_id}</td>
        <td>${r.first_name || ''}</td>
        <td>${r.last_name || ''}</td>
        <td>${r.email || ''}</td>
        <td>${r.phone_number || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.hire_date || ''}</td>
        <td>
          <button class="action-btn" onclick="openModal('lecturers', ${r.lecturer_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('lecturers', ${r.lecturer_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='courses'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.course_id}</td>
        <td>${r.title || ''}</td>
        <td>${r.description || ''}</td>
        <td>${r.credits || ''}</td>
        <td>${r.department || ''}</td>
        <td>${r.lecturer_last_name || (r.lecturer_id || '')}</td>
        <td>
          <button class="action-btn" onclick="openModal('courses', ${r.course_id})">‚úèÔ∏è</button>
          <button class="action-btn" onclick="deleteRow('courses', ${r.course_id})">üóëÔ∏è</button>
        </td>`;
      tbody.appendChild(tr);
    });
    appendAddRow(table, tbody);
    return;
  }

  if(table==='grades'){
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.grade_id}</td>
        <td>${r.student_last_name ||   ''} ${r.student_first_name || ''} ${r.student_pytronimic || ''}</td>
        <td>${r.course_title || ''}</td>
        <td>${r.semester || ''}</td>
        <td>${r.final_grade || ''}</td>
        <td>${r.created_at || ''}</td>`;
      tbody.appendChild(tr);
    });
    // no add/edit/delete row appended here? We might allow add ‚Äî keep add option:
    appendAddRow(table, tbody, true); // allow add for grades but no edit/delete in rows
    return;
  }
}

/* add-row: creates a full-width row with "Add" button; if forGradesAddOnlyOnly flag */
function appendAddRow(table, tbody, gradesAddOnly=false){
  const tr = document.createElement('tr');
  const colCount = tbody.parentElement.querySelector('thead tr').children.length;
  const td = document.createElement('td');
  td.colSpan = colCount;
  if(table==='grades') {
    td.innerHTML = `<button onclick="openModal('grades')">–î–æ–±–∞–≤–∏—Ç—å –æ—Ü–µ–Ω–∫—É</button>`;
  } else {
    td.innerHTML = `<button onclick="openModal('${table}')">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>`;
  }
  tr.appendChild(td);
  tbody.appendChild(tr);
}

/* ---------- CRUD actions ---------- */
async function deleteRow(table, id){
  if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å ID=${id} –∏–∑ ${table}?`)) return;
  try{
    const res = await fetch(`/api/${table}/${id}`, { method:'DELETE' });
    if(!res.ok) throw new Error('Delete error');
    await loadData(table);
  }catch(err){ alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è'); console.error(err); }
}





/* ==========================================================
   –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ö–õ–ê–î–û–ö
========================================================== */
document.querySelectorAll(".tab").forEach(tab => {
    tab.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        document.querySelectorAll(".table-block, #student-panel")
            .forEach(b => b.classList.add("hidden"));

        const target = tab.dataset.target;
        const block = document.getElementById(target);
        if (block) block.classList.remove("hidden");

        if (target === "student-panel") loadStudentList();
    });
});


/* ==========================================================
   1. –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –°–¢–£–î–ï–ù–¢–û–í
========================================================== */
async function loadStudentList() {
    const sel = document.getElementById("stat-student-select");
    sel.innerHTML = `<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>`;
    document.getElementById("course-block").classList.add("hidden");
    document.getElementById("prediction-result").innerHTML = "";

    const res = await fetch("/api/students");
    const students = await res.json();

    sel.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞ --</option>`;
    students.forEach(s => {
        sel.innerHTML += `<option value="${s.student_id}">
            ${s.last_name} ${s.first_name}
        </option>`;
    });

    sel.onchange = onStudentSelected;
}


/* ==========================================================
   2. –ü–û–°–õ–ï –í–´–ë–û–†–ê –°–¢–£–î–ï–ù–¢–ê ‚Üí –ü–û–î–ì–†–£–ñ–ê–ï–ú –ö–£–†–°–´ –ë–ï–ó –û–¶–ï–ù–û–ö
========================================================== */
async function onStudentSelected() {
    const id = this.value;
    const courseSel = document.getElementById("stat-course-select");
    const block = document.getElementById("course-block");
    const resultBox = document.getElementById("prediction-result");

    courseSel.innerHTML = "<option>–ó–∞–≥—Ä—É–∑–∫–∞...</option>";
    resultBox.innerHTML = "";
    block.classList.add("hidden");

    if (!id) return;

    // –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—Å–æ–≤
    const allCourses = await (await fetch("/api/courses")).json();

    // –ø–æ–ª—É—á–∞–µ–º –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
    const grades = await (await fetch(`/api/grades/student/${id}`)).json();

    const learnedIds = new Set(grades.map(g => Number(g.course_id)));

    const available = allCourses.filter(c => !learnedIds.has(Number(c.course_id)));

    courseSel.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç --</option>`;
    available.forEach(c => {
        courseSel.innerHTML += `<option value="${c.course_id}">${c.title}</option>`;
    });

    block.classList.remove("hidden");
}


/* ==========================================================
   3. –ü–†–û–ì–ù–û–ó
========================================================== */

document.getElementById("makePredictionBtn").onclick = makePrediction;

async function makePrediction() {
    const studentId = document.getElementById("stat-student-select").value;
    const courseId = document.getElementById("stat-course-select").value;
    const resultBox = document.getElementById("prediction-result");

    if (!studentId) {
        resultBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—É–¥–µ–Ω—Ç–∞.";
        return;
    }
    if (!courseId) {
        resultBox.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.";
        return;
    }

    resultBox.textContent = "–†–∞—Å—á—ë—Ç...";

    // –æ—Ü–µ–Ω–∫–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞
    const grades = await (await fetch(`/api/grades/student/${studentId}`)).json();
    const numeric = grades.map(g => Number(g.final_grade)).filter(v => !isNaN(v));

    if (numeric.length === 0) {
        resultBox.textContent = "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞.";
        return;
    }

    const avg = numeric.reduce((a,b)=>a+b,0) / numeric.length;

    // –ø—Ä–æ—Å—Ç–æ–π —Ç—Ä–µ–Ω–¥ (—Ä–∞–∑–Ω–æ—Å—Ç–Ω–∞—è)
    let trend = 0;
    for (let i=1;i<numeric.length;i++) trend += numeric[i]-numeric[i-1];
    trend /= numeric.length || 1;

    let predicted = avg + trend;
    predicted = Math.max(0, Math.min(10, predicted));

    resultBox.innerHTML = `
        <b>–û–∂–∏–¥–∞–µ–º–∞—è –æ—Ü–µ–Ω–∫–∞:</b> 
        <span style="color:green; font-size:22px;">
            ${predicted.toFixed(1)} / 10
        </span>
    `;

    drawChart(grades);
}


/* ==========================================================
   4. –ì–†–ê–§–ò–ö
========================================================== */
let chart = null;

function drawChart(data) {
    const ctx = document.getElementById("studentChart").getContext("2d");

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.map(d => d.course_title),
            datasets: [{
                label: "–û—Ü–µ–Ω–∫–∏",
                data: data.map(d => d.final_grade),
                borderColor: "#4caf50",
                borderWidth: 2
            }]
        }
    });
}
</script>
</body>
</html>
